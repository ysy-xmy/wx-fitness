"use strict";const t=require("../../common/vendor.js");require("../../utils/request.js");const g=require("../../state/modules/auth.js"),x=require("./wx_session.js");function m(r){const a=g.useAuthStore();t.index.login({provider:"weixin",success:function(n){const{code:i}=n;console.log("code",i),t.index.request({url:`https://sit.2018ctjs.cn/api/user/wx-login?code=${i}`,method:"POST",success:e=>{if(e.data.code===200){const s=e.data.data.Token;t.index.setStorageSync("token",s);const c={OpenID:e.data.data.OpenID,name:e.data.data.Username,id:e.data.data.ID,phone:e.data.data.phone,Sex:e.data.data.Sex||0,img:e.data.data.Avatar,RoleName:e.data.data.RoleName,Age:e.data.data.Age||"18"};a.setUser(c),a.setToken(s),r(s,c),t.index.getUserInfo({success:o=>{const{nickName:u,avatarUrl:l,gender:h}=o.userInfo,d={OpenID:o.data.data.OpenID,Username:u,Avatar:l,Sex:h};x.updateUserInfo(d).then(()=>{console.log("更新用户信息成功"),t.index.showToast({title:"登录成功",icon:"success",duration:2e3}),a.setUserInfo(d)}).catch(f=>{console.error("更新用户信息失败：",f)})},fail:o=>{console.error("获取用户信息失败：",o)}})}e.data.code===500&&t.index.showToast({title:"用户已经被禁用，请联系管理员",icon:"none"})},fail:e=>{console.error("登录失败：",e),t.index.showToast({title:"登录失败",icon:"none"})}})},fail:function(n){console.error("微信登录失败：",n)}})}exports.loginWithWeChat=m;
