"use strict";const t=require("../../common/vendor.js"),L=require("../../api/action/action.js"),J=require("../../state/modules/auth.js"),K=require("../../api/course/index.js");require("../../utils/request.js");require("../../state/modules/mes.js");require("../../api/notify/index.js");if(!Array){const C=t.resolveComponent("cu-custom"),h=t.resolveComponent("van-icon"),y=t.resolveComponent("van-checkbox"),D=t.resolveComponent("transition"),S=t.resolveComponent("van-empty"),_=t.resolveComponent("van-index-bar"),A=t.resolveComponent("van-stepper"),v=t.resolveComponent("van-button"),g=t.resolveComponent("van-popup");(C+h+y+D+S+_+A+v+g)()}const W=t.defineComponent({__name:"index",props:{stuid:null,courid:null,type:null,ifChoose:{type:Boolean},name:null},setup(C){const h=C,y=t.ref(!1),D=J.useAuthStore(),S=t.H(),_=t.ref([{name:"A",id:0,OrderNum:1,children:[]}]),A=t.ref(),v=t.ref(""),g=t.ref([]);_.value=m(_.value);const s=t.ref([]),I=t.ref([]),p=t.ref(0),i=t.ref(0),N=t.ref(0),x=t.ref(""),T=(o,c)=>{if(d.value){const e=d.value.find(n=>n.id==o.id);e&&Reflect.set(e,"num",c.detail)}},O=(o,c)=>{c.forEach(e=>{e!==o&&(e.active=!1)}),o.active=!o.active},E=()=>{let o=d.value;if(o=o.filter(c=>c.num!=0),o.length==0)t.index.showToast({title:"当前没有动作",icon:"error"});else{let c=[];d.value.forEach(n=>{c.push({ExerciseActionID:n.id,ActionName:n.name,GroupNum:n.num})});let e={UserID:Number(h.stuid),UserCourseID:Number(D.getClass),Type:h.type,PlanTime:t.dayjs(q()).format("YYYY-MM-DD"),Actions:c};K.postPlan(e).then(n=>{t.index.showToast({title:"添加成功！"}),t.index.$emit("getNew",!0),S.back()}).catch(n=>{t.index.showToast({title:"添加失败！",icon:"error"})})}};function q(){const o=new Date,c=o.getFullYear(),e=(o.getMonth()+1).toString().padStart(2,"0"),n=o.getDate().toString().padStart(2,"0"),a=o.getHours().toString().padStart(2,"0"),r=o.getMinutes().toString().padStart(2,"0"),l=o.getSeconds().toString().padStart(2,"0");return`${c}-${e}-${n} ${a}:${r}:${l}`}const k=(o,c)=>{const e="https://zhanjiang-fitness.oss-cn-guangzhou.aliyuncs.com/20241007/1728284282969.png";return o&&o[c]?o[c].URL:e},b=()=>{y.value=!1};function B(o,c){let e=!1;return function(){const n=arguments,a=this;e||(o.apply(a,n),e=!0,setTimeout(()=>e=!1,c))}}function j(o){const c=[];return o.forEach(e=>{const n=e.FirstCategory,a={name:n.Name,id:n.ID,OrderNum:n.OrderNum,children:[]};e.SecondCategoryInfos&&e.SecondCategoryInfos.forEach(r=>{const l=r.SecondCategory,u={name:l.Name,id:l.ID,OrderNum:l.OrderNum,children:[]};r.ActionInfos&&r.ActionInfos.forEach(f=>{const G={CreatedAt:f.ActionInfos.CreatedAt,Description:f.ActionInfos.Description,id:f.ActionInfos.ID,name:f.ActionInfos.Name,OrderNum:f.ActionInfos.OrderNum,SecondCategoryID:f.ActionInfos.SecondCategoryID};u.children.push(G)}),a.children.push(u)}),c.push(a)}),c}function z(o,c){for(let e=0;e<o.length;e++){const n=o[e];if(n.children&&n.children.length>0)for(let a=0;a<n.children.length;a++){const r=n.children[a];if(r.children&&r.children.length>0){for(let l=0;l<r.children.length;l++)if(r.children[l].id===c)return{firstCategoryId:n.id,secondCategoryId:r.id}}}}return{firstCategoryId:null,secondCategoryId:null}}function m(o){const c=(n,a)=>n.OrderNum!==a.OrderNum?a.OrderNum-n.OrderNum:a.id-n.id,e=n=>n?n.map(a=>({...a,ifcheck:!!d.value.find(r=>r.id==a.id),children:e(a.children)})).sort(c):[];return o.map(n=>({...n,children:e(n.children)})).sort(c)}const M=o=>{h.ifChoose||S.push({name:"actionDetail",params:{itemid:String(o.id)}})},V=async o=>{const{firstCategoryId:c,secondCategoryId:e}=z(s.value,o),n=s.value.findIndex(r=>r.id===c),a=s.value[n].children.findIndex(r=>r.id===e);if(n!==-1&&a!==-1){p.value=n,i.value=n,N.value=(n-1)*50,s.value[n].children.forEach(l=>l.active=!1);const r=s.value[n].children[a];(!r.children.length||!r.children[0].Imgs)&&await L.getActionsBySec(String(r.id)).then(l=>{r.children=l.data.data.map(u=>({id:u.ID,name:u.Name,OrderNum:u.OrderNum,children:[],Imgs:u.Imgs,Videos:u.Videos,Description:u.Description,CreatedAt:u.CreatedAt})),s.value=m(s.value)}),w(s.value[n]),t.nextTick$1(()=>{s.value[n].children[a].active=!0;const l=s.value[n].children[a].children.findIndex(u=>u.id===o);l!==-1&&(O(s.value[n].children[a].children[l],s.value[n].children[a].children),x.value="action-"+o)})}v.value="",F(s.value,v.value)},R=(o,c)=>{s.value[i.value].children[c].active=!s.value[i.value].children[c].active,!s.value[i.value].children[c].children[0].Imgs&&L.getActionsBySec(String(o.id)).then(e=>{s.value[i.value].children[c].children=e.data.data.map(n=>({id:n.ID,name:n.Name,OrderNum:n.OrderNum,children:[],Imgs:n.Imgs,Videos:n.Videos,Description:n.Description,CreatedAt:n.CreatedAt})),s.value=m(s.value)})},F=(o,c)=>{if(!c)return g.value=[],[];const e=[],n=(a,r={})=>{if(typeof a.name=="string"&&a.name.toLowerCase().includes(c.toLowerCase())){const l={...a,firstCategory:r.first||a.name,secondCategory:r.second,isFirstLevel:!r.first,isSecondLevel:!!r.first&&!r.second,isAction:!!r.first&&!!r.second};e.push(l)}a.children&&a.children.length>0&&a.children.forEach(l=>{r.first?r.second?n(l,r):n(l,{first:r.first,second:a.name}):n(l,{first:a.name})})};return o.forEach(a=>n(a)),e.sort((a,r)=>a.isFirstLevel&&!r.isFirstLevel?-1:!a.isFirstLevel&&r.isFirstLevel?1:a.isSecondLevel&&!r.isSecondLevel?-1:!a.isSecondLevel&&r.isSecondLevel?1:0),A.value=e.map(a=>a.name),g.value=e,e};t.watch(v,B(function(o){F(s.value,o)},50)),t.reactive({stuId:-1,courseId:-1,type:""}),t.onMounted(async()=>{try{t.index.showLoading({title:"加载中...",mask:!0});const o=await L.getActionAll(),c=j(o.data.data);if(s.value=m(c),s.value.length>0){p.value=0,i.value=0,N.value=0;const e=s.value[0];await $(e)}t.index.hideLoading()}catch(o){t.index.hideLoading(),t.index.showToast({title:"加载失败",icon:"error"}),console.error("初始化数据失败:",o)}});const $=async o=>{const c=o.id;if(o.children.length>0){w(o);return}try{t.index.showLoading({title:"加载中...",mask:!0});const e=await L.getSecByFirst(c);e.data.data.length>0&&(s.value.find(n=>n.id===c).children=e.data.data.map(n=>({id:n.ID,name:n.Name,OrderNum:n.OrderNum,children:[],active:!1}))),w(o),s.value=m(s.value)}finally{t.index.hideLoading()}},d=t.ref([]),U=(o,c,e,n)=>{const a=s.value[e].children[n].children.find(r=>r==c);a&&(a.ifcheck?d.value=d.value.filter(r=>r.id!=c.id):d.value.push({...c,num:0}),s.value[e].children[n].children.find(r=>r==c).ifcheck=!a.ifcheck)},w=o=>{let c=[];o.children&&(o.children.length>0?(o.children.forEach(e=>{let n={name:e.name,id:e.id,OrderNum:e.OrderNum,children:[]};c.push(n)}),I.value=m(c)):(c=[],I.value=c))},Y=async o=>{const c=o.currentTarget.dataset.id;p.value=c,i.value=c,N.value=(c-1)*50,$(s.value[c])},H=()=>{v.value="",g.value=[]};return(o,c)=>t.e({a:v.value,b:t.o(e=>v.value=e.detail.value),c:v.value},v.value?{d:t.o(H)}:{},{e:h.ifChoose},h.ifChoose?{f:t.t(h.name),g:t.t(d.value.length),h:t.o(e=>y.value=!0)}:{},{i:t.p({isBack:!1,bgColor:"bg-shadeTop text-white"}),j:t.f(s.value,(e,n,a)=>({a:t.t(e.name),b:e.id,c:n==p.value?"#5adade":"#f7f8fc",d:n==p.value?"#ffffff":"",e:n==p.value?"bold":"",f:n==p.value?"5px":"",g:t.o(Y,e.id),h:n})),k:N.value,l:I.value.length>0},I.value.length>0?{m:t.f(I.value,(e,n,a)=>t.e({a:t.t(e.name),b:s.value[i.value].children[n].active,c:"98432c04-1-"+a,d:!s.value[i.value].children[n].active,e:"98432c04-2-"+a,f:t.o(r=>R(e,n),e.id),g:s.value[i.value].children[n].active},s.value[i.value].children[n].active?t.e({h:t.f(s.value[i.value].children[n].children,(r,l,u)=>t.e(C.ifChoose?{a:t.o(f=>U(f,r,i.value,n),r.id),b:"98432c04-3-"+a+"-"+u,c:t.p({value:r.ifcheck,checkedColor:"#f60422"})}:{},{d:t.t(r.name),e:t.o(f=>O(r,s.value[i.value].children[n].children),r.id),f:r.active&&r.Imgs},r.active&&r.Imgs?{g:k(r.Imgs,0),h:k(r.Imgs,1),i:t.o(f=>M(r),r.id)}:{},{j:"98432c04-4-"+a+"-"+u,k:"action-"+r.id,l:r.id})),i:C.ifChoose,j:t.p({name:"fade"}),k:s.value[i.value].children[n].children.length==0},s.value[i.value].children[n].children.length==0?{l:"98432c04-5-"+a,m:t.p({description:"该目录暂无具体动作",image:"search"})}:{}):{},{n:e.id,o:"main-"+n})),n:t.p({name:"arrow-down"}),o:t.p({name:"arrow-up"})}:{p:t.p({description:"没有数据"})},{q:x.value,r:g.value.length>0},g.value.length>0?{s:t.f(g.value,(e,n,a)=>t.e({a:e.isFirstLevel},e.isFirstLevel?{}:e.isSecondLevel?{}:{},{b:e.isSecondLevel,c:t.t(e.isFirstLevel?"一级目录":e.isSecondLevel?"二级目录":"动作"),d:e.isFirstLevel?1:"",e:e.isSecondLevel?1:"",f:e.isAction?1:"",g:t.t(e.name),h:!e.isFirstLevel},e.isFirstLevel?{}:{i:t.t(e.isAction?`${e.firstCategory} > ${e.secondCategory}`:e.firstCategory)},{j:t.o(r=>V(e.isAction?e.id:e.children&&e.children.length>0?e.children[0].id:e.id),e.id),k:e.isFirstLevel?1:"",l:e.isSecondLevel?1:"",m:e.isAction?1:"",n:e.id})),t:t.p({["index-list"]:A.value})}:{},{v:t.o(b),w:t.p({name:"close",size:"30px"}),x:d.value.length==0},d.value.length==0?{y:t.p({description:"暂未选择动作"})}:{},{z:t.f(d.value,(e,n,a)=>({a:t.t(e.name),b:t.o(r=>T(e,r),e),c:"98432c04-11-"+a+",98432c04-8",d:t.p({value:e.num,integer:!0,min:"0",step:"1"}),e})),A:t.o(E),B:t.p({type:"info",size:"normal",round:!0}),C:t.o(b),D:t.p({customStyle:"max-height: 500px;",show:y.value,position:"bottom",overlay:"false"})})}}),X=t._export_sfc(W,[["__file","J:/fItness/wx-fitness/apps/fitness/src/components/action/index.vue"]]);wx.createComponent(X);
