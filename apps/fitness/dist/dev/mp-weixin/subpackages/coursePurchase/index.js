"use strict";const e=require("../../common/vendor.js"),O=require("../apis/api.js"),w=require("../../state/modules/auth.js"),x=require("../apis/pay/index.js"),b=require("../../api/user/index.js");require("../../utils/request.js");require("../../state/modules/mes.js");require("../../api/notify/index.js");if(!Array){const y=e.resolveComponent("van-cell"),s=e.resolveComponent("van-icon");(y+s)()}const D=e.defineComponent({__name:"index",setup(y){const s=e.H(),u=w.useAuthStore(),f=()=>{if(console.log(i.value,"num"),!t.value&&a.id!=""){e.index.showLoading({title:"计算价格中~"});let o={CoachID:a.id,CourseType:n.value,PaymentType:"WECHAT",PaymentFor:"OTHER",PaymentTo:"OTHER",Remark:"",UserPhone:m.value||"",UserRealName:v.value||0,Amount:Number(c.price)||0};if(n.value=="LESSON"&&i.value&&(o.LessonCount=Number(i.value)),n.value=="LESSON"&&!i.value){e.index.hideLoading();return}O.getPrice(o).then(l=>{c.price=l.data.data.Amount,e.index.hideLoading()})}};e.onMounted(()=>{e.index.setStorageSync("toBuy",""),e.index.$on("chooseCoach",o=>{a.id=o.ID,a.avatar=o.Avatar,a.name=o.Username,a.phone=o.Phome||"暂无联系方式",a.sex=o.Sex,a.ifFind=!0,f()}),s.route.value.query&&(s.route.value.query.ifDiy=="true"?(d=s.route.value.query,c.price=decodeURIComponent(d.price),a.mount=decodeURIComponent(d.count),t.value=!0,a.avatar=decodeURIComponent(d.img),a.phone=decodeURIComponent(d.phone),a.name=decodeURIComponent(d.name),a.id=decodeURIComponent(d.id),a.sex=Number(decodeURIComponent(d.sex))):t.value=!1)});const a=e.reactive({id:"",phone:"",avatar:"",name:"",mount:"",sex:0,ifFind:!1}),t=e.ref(!1),i=e.ref("10"),n=e.ref("LESSON"),m=e.ref(),v=e.ref(),h=e.ref(!1),c=e.reactive({title:"私教课",price:"0",time:e.dayjs().format("YYYY-MM-DD"),place:"北京市海淀区西二旗北路10号院"}),N=()=>{s.push({path:"/subpackages/coachcontact/index?ifChoose=true"})};let d={};const _=21.2353,k=110.4195,S="常态健身俱乐部",C=()=>{e.index.openLocation({latitude:_,longitude:k,name:S,address:S,scale:18})},T=async()=>{if(!h.value){if(!e.index.getStorageSync("token")){const o={name:a.name,phone:a.phone,img:a.avatar,count:i.value,price:c.price,ifDiy:!0,id:a.id,sex:a.sex},l=Object.keys(o).map(r=>`${r}=${encodeURIComponent(o[r])}`).join("&");s.replace({path:`/pages/login/index?${l}`});return}if(console.log("身份验证"),!u.user||Object.keys(u.user).length===0||!u.user.id||!u.user.OpenID){e.index.showLoading("正在获取用户信息..."),b.getUserInfo().then(o=>{e.index.hideLoading(),u.setUser({OpenID:o.data.data.OpenID,name:o.data.data.Username||"微信用户",id:o.data.data.ID,phone:o.data.data.phone,Sex:o.data.data.Sex||0,img:o.data.data.Avatar,RoleName:o.data.data.RoleName,Age:o.data.data.Age||"18"}),T()}).catch(o=>{e.index.hideLoading(),e.index.showToast({icon:"error",title:"获取用户身份失败！"})});return}try{if(!a.ifFind&&!t.value){e.index.showToast({title:"请先选择教练",icon:"error"});return}if(!m.value||!v.value){e.index.showToast({title:"请填写真实姓名和联系电话",icon:"error"});return}h.value=!0,e.index.showLoading();const o={Description:u.user.id+"购买"+a.id+"的课程",Amount:Number(c.price)*100,OpenID:u.user.OpenID},l=await x.getPaySignature(o),r=l.data.data;console.log(l,123),console.log(l.data,123),console.log(r,123);const g={CoachID:Number(a.id),CourseType:n.value,PaymentType:"WECHAT",PaymentFor:"OTHER",PaymentTo:"OTHER",Remark:"",UserPhone:v.value,UserRealName:m.value,Amount:Number(c.price),UserID:Number(u.user.id)};n.value==="LESSON"&&(g.LessonCount=Number(i.value));const R=await x.checkPay(g);if(R.data.code!==200){e.index.showToast({title:R.data.msg,icon:"error"});return}e.index.requestPayment({provider:"wxpay",timeStamp:r.TimeStamp,nonceStr:r.NonceStr,package:r.Package,signType:r.SignType,paySign:r.Sign,success:async()=>{try{const p=await x.buyCourse(g);p.data.code===200?(e.index.$emit("alreadyBuy"),e.index.showToast({title:"购买成功",icon:"success"}),setTimeout(()=>{s.push({name:"home"})},3e3)):e.index.showToast({title:p.data.msg,icon:"error"})}catch(p){console.log(p),e.index.showToast({title:"购买失败!请联系工作人员",icon:"error"})}},fail:p=>{console.log("支付失败:",p),e.index.showToast({title:"支付已取消",icon:"none"})}})}catch(o){console.error("支付过程出错:",o),e.index.showToast({title:"支付异常，请稍后重试",icon:"error"})}finally{setTimeout(()=>{h.value=!1,e.index.hideLoading()},2500)}}},P=()=>{e.index.setClipboardData({data:"32456",success:function(){e.index.showToast({title:"复制号码成功",icon:"none"})}})},I=o=>{console.log(n.value),n.value=o.detail.value,f()},L=o=>{i.value=o.detail.value,f()};return(o,l)=>e.e({a:e.t(c.title),b:e.t(a.ifFind?"￥"+c.price:""),c:e.o(C),d:!t.value},t.value?{}:{e:e.n(n.value=="LESSON"?"checked":""),f:n.value=="LESSON",g:e.n(n.value=="MONTH"?"checked":""),h:n.value=="MONTH",i:e.n(n.value=="QUARTER"?"checked":""),j:n.value=="QUARTER",k:e.n(n.value=="YEAR"?"checked":""),l:n.value=="YEAR"},{m:e.o(I),n:n.value=="LESSON"},n.value=="LESSON"?e.e({o:!t.value},t.value?{x:e.t(a.mount)}:{p:e.n(i.value=="10"?"checked":""),q:i.value=="10",r:e.n(i.value=="15"?"checked":""),s:i.value=="15",t:e.n(i.value=="25"?"checked":""),v:i.value=="25",w:e.o(L)}):{},{y:!t.value},t.value?{}:{z:e.o(N),A:e.p({title:"选择教练",value:a.ifFind?a.name:"请选择教练",isLink:!0,to:"home"})},{B:a.ifFind||t.value},a.ifFind||t.value?e.e({C:a.avatar,D:e.t(a.name),E:a.sex==1},a.sex==1?{}:{},{F:e.t(a.phone),G:a.phone!="暂无联系方式"},a.phone!="暂无联系方式"?{}:{},{H:e.o(P)}):{},{I:m.value,J:e.o(r=>m.value=r.detail.value),K:v.value,L:e.o(r=>v.value=r.detail.value),M:e.p({name:"warning"}),N:e.p({name:"checked",color:"#666f7a"}),O:e.p({name:"checked",color:"#666f7a"}),P:e.p({name:"checked",color:"#666f7a"}),Q:e.p({name:"checked",color:"#666f7a"}),R:e.t(a.ifFind||t.value?"￥"+c.price:""),S:e.o(T),T:h.value})}}),E=e._export_sfc(D,[["__file","J:/fItness/wx-fitness/apps/fitness/src/subpackages/coursePurchase/index.vue"]]);wx.createPage(E);
